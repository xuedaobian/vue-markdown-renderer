import{_ as e,c as i,o as s,ag as l}from"./chunks/framework.CA53vVaN.js";typeof window<"u"&&window.location.replace("/zh/guide/katex-worker-performance-analysis");const c=JSON.parse('{"title":"KaTeX Worker 性能（重定向）","description":"","frontmatter":{},"headers":[],"relativePath":"zh/katex-worker-performance-analysis.md","filePath":"zh/katex-worker-performance-analysis.md"}'),r={name:"zh/katex-worker-performance-analysis.md"};function t(n,a,o,h,p,k){return s(),i("div",null,[...a[0]||(a[0]=[l(`<h1 id="katex-worker-性能-重定向" tabindex="-1">KaTeX Worker 性能（重定向） <a class="header-anchor" href="#katex-worker-性能-重定向" aria-label="Permalink to &quot;KaTeX Worker 性能（重定向）&quot;">​</a></h1><p>该页面已迁移到中文指南目录：</p><ul><li>新页面：<code>/zh/guide/katex-worker-performance-analysis</code></li></ul><p>如果你的链接仍指向 <code>/zh/katex-worker-performance-analysis</code>，页面将自动跳转。</p><noscript> 页面已迁移：请访问 <a href="/zh/guide/katex-worker-performance-analysis">中文指南 – KaTeX Worker 性能</a></noscript> # KaTeX Worker 性能分析指南（中文） <h2 id="问题-worker-是否比直接渲染更合适" tabindex="-1">问题：Worker 是否比直接渲染更合适？ <a class="header-anchor" href="#问题-worker-是否比直接渲染更合适" aria-label="Permalink to &quot;问题：Worker 是否比直接渲染更合适？&quot;">​</a></h2><p>本文档帮助你判断在何种场景下使用 Web Worker 会带来性能优势。</p><h2 id="快速结论" tabindex="-1">快速结论 <a class="header-anchor" href="#快速结论" aria-label="Permalink to &quot;快速结论&quot;">​</a></h2><p><strong>是的，Worker + Cache 架构在大多数真实场景中有显著优势。</strong></p><p>关键原因：</p><ol><li>Cache 能消除大部分重复渲染开销（缓存命中率通常 &gt;70%）</li><li>Worker 能阻止主线程被阻塞，从而保证 UI 响应</li><li>内存占用极小（举例：200 个公式大约 10–50KB）</li></ol><h2 id="简要对比-场景" tabindex="-1">简要对比（场景） <a class="header-anchor" href="#简要对比-场景" aria-label="Permalink to &quot;简要对比（场景）&quot;">​</a></h2><ul><li><p>场景：单个简单公式</p><ul><li>直接渲染：约 2–5ms</li><li>Worker：约 3–7ms（含通信开销）</li><li>结论：Worker 略慢，但差异可以忽略</li></ul></li><li><p>场景：单个复杂公式</p><ul><li>直接渲染：约 20–50ms（阻塞主线程）</li><li>Worker：约 22–52ms（不阻塞）</li><li>结论：Worker 明显改善用户体验</li></ul></li><li><p>场景：重复公式多（带缓存）</p><ul><li>直接渲染：5ms × 10 次 = 50ms</li><li>Worker + Cache：5ms + 0.01ms × 9 次 ≈ 5.09ms</li><li>结论：Worker 快约 10 倍</li></ul></li><li><p>真实文档（混合场景）</p><ul><li>50 个公式，其中 35 个重复</li><li>无缓存：250ms（全部渲染）</li><li>有缓存：75ms（仅渲染 15 个）</li><li>缓存命中率：70%</li><li>性能提升：3.3×</li></ul></li></ul><h2 id="如何运行基准测试" tabindex="-1">如何运行基准测试 <a class="header-anchor" href="#如何运行基准测试" aria-label="Permalink to &quot;如何运行基准测试&quot;">​</a></h2><ol><li>安装依赖</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span></span></code></pre></div><ol start="2"><li>运行 KaTeX Worker 对比测试</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test/benchmark/katex-worker-vs-direct.test.ts</span></span></code></pre></div><ol start="3"><li>查看更详细报告</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test/benchmark/katex-worker-vs-direct.test.ts</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --reporter=verbose</span></span></code></pre></div><h2 id="如何判断是否应该启用-worker" tabindex="-1">如何判断是否应该启用 Worker <a class="header-anchor" href="#如何判断是否应该启用-worker" aria-label="Permalink to &quot;如何判断是否应该启用 Worker&quot;">​</a></h2><p>当一次渲染的“唯一公式数”大于阈值 N 时，使用 Worker 更安全。经验公式：</p><p>N ≈ floor(B / (R × (1 - H)))</p><ul><li>B：主线程预算（ms），常用 50ms（卡顿阈值）或 16.7ms（单帧预算）</li><li>R：单个“唯一公式”的平均渲染耗时（ms）</li><li>H：缓存命中率（0..1）</li></ul><p>仓库中提供了一个测量脚本：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> scripts/measure-katex-threshold.mjs</span></span></code></pre></div><p>此外，<code>vue-renderer-markdown</code> 提供了辅助函数可推荐阈值：</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { recommendNForSamples, recommendWorkerThreshold } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vue-renderer-markdown/utils/katex-threshold&#39;</span></span></code></pre></div><h2 id="浏览器中实时监控性能" tabindex="-1">浏览器中实时监控性能 <a class="header-anchor" href="#浏览器中实时监控性能" aria-label="Permalink to &quot;浏览器中实时监控性能&quot;">​</a></h2><p>可以在应用中启用性能监控：</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { enablePerfMonitoring, getPerfReport } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vue-renderer-markdown/utils/performance-monitor&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enablePerfMonitoring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getPerfReport</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>或者在浏览器控制台运行：</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">window.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__katexPerfReport</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">window.__katexPerfMonitor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">exportMetrics</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><h2 id="使用-chrome-devtools-分析" tabindex="-1">使用 Chrome DevTools 分析 <a class="header-anchor" href="#使用-chrome-devtools-分析" aria-label="Permalink to &quot;使用 Chrome DevTools 分析&quot;">​</a></h2><ul><li>Performance：录制渲染流程；查看主线程与 Worker 的时间</li><li>Memory：检查 cache 的内存占用</li><li>Performance Monitor：观察 CPU、JS heap、帧率等</li></ul><h2 id="决策表" tabindex="-1">决策表 <a class="header-anchor" href="#决策表" aria-label="Permalink to &quot;决策表&quot;">​</a></h2><p>推荐使用 Worker 的场景：</p><ul><li>复杂公式</li><li>每页多个公式</li><li>大量重复公式（命中缓存）</li><li>需要流畅交互（滚动、动画）</li><li>移动端（CPU 弱）</li></ul><p>适合直接渲染的场景：</p><ul><li>仅简单公式（&lt;5ms）</li><li>SSR 或没有 Worker API 的环境</li><li>对包体积有严格限制</li></ul><h2 id="最佳实践" tabindex="-1">最佳实践 <a class="header-anchor" href="#最佳实践" aria-label="Permalink to &quot;最佳实践&quot;">​</a></h2><ul><li>使用 Worker + Cache 作为默认策略，并保留主线程 fallback</li><li>对常见公式做预渲染或预热缓存</li><li>使用 requestIdleCallback 做非关键渲染</li><li>根据实际测量调整 <code>CACHE_MAX</code> 大小</li></ul><h2 id="测量示例与结论" tabindex="-1">测量示例与结论 <a class="header-anchor" href="#测量示例与结论" aria-label="Permalink to &quot;测量示例与结论&quot;">​</a></h2><ul><li>Worker+Cache 在多数混合文档场景下能将渲染时间减少到原来的约 1/3</li><li>内存开销很小，通常无需担心</li><li>Worker 防止主线程阻塞，提高用户体验</li></ul><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-label="Permalink to &quot;参考&quot;">​</a></h2><ul><li>Chrome Performance 文档：<a href="https://developer.chrome.com/docs/devtools/performance/" target="_blank" rel="noreferrer">https://developer.chrome.com/docs/devtools/performance/</a></li><li>Web Worker 性能说明：<a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers#performance_considerations" target="_blank" rel="noreferrer">https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers#performance_considerations</a></li><li>KaTeX 性能提示：<a href="https://katex.org/docs/performance.html" target="_blank" rel="noreferrer">https://katex.org/docs/performance.html</a></li></ul>`,47)])])}const g=e(r,[["render",t]]);export{c as __pageData,g as default};
